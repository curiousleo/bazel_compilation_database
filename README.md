# Export compile commands from Bazel

This repository provides a plugin for [Bazel](https://bazel.build) to create a Clang tooling
compatible [JSON compilation database](http://clang.llvm.org/docs/JSONCompilationDatabase.html)
(`compile_commands.json`).

[YouCompleteMe](https://github.com/valloric/YouCompleteMe) can use the same file for [semantic
completion](https://valloric.github.io/YouCompleteMe/#c-family-semantic-completion).

Note that in order to use the `compile_commands.json` generated by this plugin with Clang tooling,
you need to set up Bazel to use Clang for compiling C and C++ in the first place
(`export CC=clang++` seems to work for me).

## Disclaimer

I am using this for my own C++ projects and thought it might be useful to others. Use at your own
risk. Only tested on Linux with Bazel 0.5.1.

## Usage

Import the repository into your `WORKSPACE`:

```
http_archive(
    name = "bazel_compilation_database",
    url = "",
    sha256sum = "",
)
```

Enable the `extra_action` that captures the compilation commands in your project's `.bazelrc`:

```
build --experimental_action_listener=@bazel_compilation_database//:capture
# Optional: restrict usage of the listener by regex
# build --experimental_extra_action_filter=^//main(/|:)
```

This handy script will then collect the compilation commands into `compile_commands.json`:

```bash
#!/usr/bin/env bash

ACTION_DIRECTORY="$(bazel info output_path)/local-fastbuild/extra_actions/external/bazel_compilation_database/capture_action"
EXEC_DIRECTORY="$(bazel info execution_root)"
COMMAND_DB_FILE="$(bazel info workspace)/compile_commands.json"

bazel run @bazel_compilation_database//:collect -- "$ACTION_DIRECTORY" "$EXEC_DIRECTORY" "$COMMAND_DB_FILE"
```

If you saved this snippet in `update_compilation_database.sh` and made it executable, then running
it after `bazel build` will update the `compile_commands.json` file in the root of your project,
like so:

```
bazel build <your target> && ./update_compilation_database.sh
```

You may need to `bazel clean` your project before this works.
